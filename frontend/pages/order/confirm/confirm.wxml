<!--订单确认页面-->
<view class="order-confirm-container">
  <!-- 收货地址 -->
  <view class="address-section" bind:tap="selectAddress">
    <view class="address-info" wx:if="{{selectedAddress}}">
      <view class="address-header">
        <text class="receiver-name">{{selectedAddress.receiver_name}}</text>
        <text class="receiver-phone">{{selectedAddress.receiver_phone}}</text>
        <view class="default-tag" wx:if="{{selectedAddress.is_default}}">默认</view>
      </view>
      <view class="address-detail">
        {{selectedAddress.province}} {{selectedAddress.city}} {{selectedAddress.district}} {{selectedAddress.detail}}
      </view>
    </view>
    <view class="no-address" wx:else>
      <text class="no-address-text">请选择收货地址</text>
    </view>
    <text class="arrow">></text>
  </view>

  <!-- 商品列表 -->
  <view class="products-section">
    <view class="section-title">商品信息</view>
    <view class="product-item" wx:for="{{orderItems}}" wx:key="index">
      <image class="product-image" src="{{item.product_image}}" mode="aspectFill"/>
      <view class="product-info">
        <view class="product-name">{{item.product_name}}</view>
        <view class="product-spec" wx:if="{{item.spec_name}}">{{item.spec_name}}</view>
        <view class="product-price">
          <text class="currency">￥</text>
          <text class="price">{{item.price}}</text>
          <text class="quantity">×{{item.quantity}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 配送方式 -->
  <view class="delivery-section">
    <view class="section-title">配送方式</view>
    <view class="delivery-option">
      <text class="delivery-name">普通配送</text>
      <text class="delivery-fee">￥{{deliveryFee}}</text>
    </view>
  </view>

  <!-- 优惠券 -->
  <view class="coupon-section" bind:tap="selectCoupon">
    <view class="section-title">优惠券</view>
    <view class="coupon-info">
      <text class="coupon-text" wx:if="{{selectedCoupon}}">{{selectedCoupon.name}}</text>
      <text class="coupon-text" wx:else>暂无可用优惠券</text>
      <text class="coupon-amount" wx:if="{{selectedCoupon}}">-￥{{selectedCoupon.amount}}</text>
    </view>
    <text class="arrow">></text>
  </view>

  <!-- 订单备注 -->
  <view class="remark-section">
    <view class="section-title">订单备注</view>
    <textarea 
      class="remark-input" 
      placeholder="选填，请先和商家协商一致" 
      value="{{remark}}"
      bind:input="onRemarkInput"
      maxlength="200"
    ></textarea>
    <view class="remark-count">{{remark.length}}/200</view>
  </view>

  <!-- 价格明细 -->
  <view class="price-section">
    <view class="section-title">价格明细</view>
    <view class="price-item">
      <text class="price-label">商品总价</text>
      <text class="price-value">￥{{totalPrice}}</text>
    </view>
    <view class="price-item">
      <text class="price-label">配送费</text>
      <text class="price-value">￥{{deliveryFee}}</text>
    </view>
    <view class="price-item" wx:if="{{discountAmount > 0}}">
      <text class="price-label">优惠券</text>
      <text class="price-value">-￥{{discountAmount}}</text>
    </view>
    <view class="price-divider"></view>
    <view class="price-item total">
      <text class="price-label">实付金额</text>
      <text class="price-value">￥{{finalAmount}}</text>
    </view>
  </view>
</view>

<!-- 底部提交栏 -->
<view class="bottom-bar">
  <view class="price-info">
    <text class="total-label">合计：</text>
    <text class="currency">￥</text>
    <text class="total-price">{{finalAmount}}</text>
  </view>
  <button 
    class="submit-btn {{canSubmit ? 'active' : 'disabled'}}" 
    bind:tap="submitOrder"
    disabled="{{!canSubmit}}"
  >
    提交订单
  </button>
</view>

<!-- 优惠券选择弹窗 -->
<view class="coupon-modal" wx:if="{{showCouponModal}}" bind:tap="hideCouponModal">
  <view class="coupon-content" catch:tap="">
    <view class="coupon-header">
      <text class="coupon-title">选择优惠券</text>
      <text class="close-btn" bind:tap="hideCouponModal">×</text>
    </view>
    <view class="coupon-list">
      <view 
        class="coupon-item {{item.id === selectedCoupon?.id ? 'selected' : ''}} {{!item.canUse ? 'disabled' : ''}}"
        wx:for="{{availableCoupons}}" 
        wx:key="id"
        bind:tap="selectCouponItem"
        data-coupon="{{item}}"
      >
        <view class="coupon-left">
          <view class="coupon-amount">
            <text class="currency">￥</text>
            <text class="amount">{{item.amount}}</text>
          </view>
          <view class="coupon-condition">满{{item.min_amount}}可用</view>
        </view>
        <view class="coupon-right">
          <view class="coupon-name">{{item.name}}</view>
          <view class="coupon-date">有效期至{{item.end_time}}</view>
        </view>
        <view class="coupon-status" wx:if="{{item.id === selectedCoupon?.id}}">✓</view>
      </view>
    </view>
    <view class="coupon-actions">
      <button class="no-coupon-btn" bind:tap="noCoupon">不使用优惠券</button>
    </view>
  </view>
</view>

<!-- 加载状态 -->
<view class="loading" wx:if="{{loading}}">
  <text>提交中...</text>
</view>